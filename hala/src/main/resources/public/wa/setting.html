<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<link rel="icon" type="image/png" href="assets/img/favicon.ico">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>Halachat Admin Website</title>

	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />


    <!-- Bootstrap core CSS     -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />

    <!--  Light Bootstrap Table core CSS    -->
    <link href="assets/css/light-bootstrap-dashboard.css?v=1.4.0" rel="stylesheet"/>

    <!--     Fonts and icons     -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet" />
</head>
<body>

<div class="wrapper">
    <div class="sidebar" data-color="purple" data-image="assets/img/sidebar-5.jpg">

    <!--   you can change the color of the sidebar using: data-color="blue | azure | green | orange | red | purple" -->


    	<div class="sidebar-wrapper">
            <div class="logo">
                <a href="http://www.creative-tim.com" class="simple-text">
                    Halachat
                </a>
            </div>

            <ul class="nav">
                <li>
                    <a href="dashboard.html">
                        <i class="pe-7s-graph"></i>
                        <p>Dashboard</p>
                    </a>
                </li>
								<li class="">
                    <a href="member.html">
                        <i class="pe-7s-user"></i>
                        <p>用户</p>
                    </a>
                </li>
                <li class="">
                    <a href="room.html">
                        <i class="pe-7s-key"></i>
                        <p>房间</p>
                    </a>
                </li>
								<li>
                    <a href="recharge.html">
                        <i class="pe-7s-cash"></i>
                        <p>充值</p>
                    </a>
                </li>
                <li>
                    <a href="feedback.html">
                        <i class="pe-7s-note"></i>
                        <p>反馈</p>
                    </a>
                </li>
                <li class="active">
                    <a href="setting.html">
                        <i class="pe-7s-plugin"></i>
                        <p>通用设置</p>
                    </a>
                </li>

                <li>
                    <a href="report.html">
                        <i class="pe-7s-alarm"></i>
                        <p>举报</p>
                    </a>
                </li>
                <li>
                    <a href="dynamicReport.html">
                        <i class="pe-7s-car"></i>
                        <p>动态举报</p>
                    </a>
                </li>
                <li><a href="memberApproval.html">
                    <i class="pe-7s-album"></i>
                    <p>人员审批</p>
                </a>
                </li>

                <li><a href="roomApproval.html">
                    <i class="pe-7s-anchor"></i>
                    <p>房间审批</p>
                </a>
                </li>

                <li> <a href="tag.html">
                    <i class="pe-7s-anchor"></i>
                    <p>标签管理</p>
                </a>
                </li>
                <li> <a href="fack.html">
                    <i class="pe-7s-bookmarks"></i>
                    <p>发布</p>
                </a>
                </li>
            </ul>
    	</div>
    </div>

    <div class="main-panel">


        <div class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="header">
                                <h4 class="title">设置</h4>
																<br/>
                                <p class="category">
																	<div class="col-md-3">
																		<input id="action-url" type="text" class="form form-control" placeholder="填入跳转URL"/>
																	</div>
																	<div class="col-md-2">
																		<input id="sortby" type="text" class="form form-control" placeholder="填入权重"/>
																	</div>
																	<div class="col-md-2">
																		<select class="form-control" id="category">
																			<option value="banner">banner</option>
																			<option value="startup">启屏</option>
																		</select>
																	</div>
																	<div class="col-md-2 text-center" id="upload-area">
                                                                        <button class="btn btn-info" id="upload-select">点击上传图片</button>
                                                                        <input id="material-url" value="" class="hidden"/>
																	</div>
																	<div class="col-md-3 text-right">
																		<button class="btn btn-search" id="add-material">上传</button>
																	</div>
																</p>
                            </div>
														<br/><br/>
                            <div class="content table-responsive table-full-width">
                                <table class="table table-hover table-striped">
                                    <thead>
                                      <th>ID</th>
										<th>图片</th>
                                    	<th>位置</th>
										<th>权重</th>
                                    	<th>跳转</th>
                                    	<th>操作</th>
                                    </thead>
                                    <tbody>

                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
										<div class="row text-right">

										</div>
                </div>
            </div>
        </div>

        <footer class="footer">
              <p class="copyright pull-right">
                  &copy; <script>document.write(new Date().getFullYear())</script> Halachat rights reserved
              </p>
        </footer>


    </div>
</div>


</body>

    <!--   Core JS Files   -->
  <script src="assets/js/jquery.3.2.1.min.js" type="text/javascript"></script>
  <script src="assets/js/bootstrap.min.js" type="text/javascript"></script>

<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<script src="https://cdn.staticfile.org/qiniu-js-sdk/1.0.14-beta/qiniu.min.js" type="text/javascript"></script>
<script src="assets/js/plupload.min.js" type="text/javascript"></script>
<script src="assets/js/qiniu.min.js" type="text/javascript"></script>
<script src="https://cdn.staticfile.org/plupload/3.1.0/i18n/ar.js" type="text/javascript"></script>

<script>
    var uploader = null;
    var authorization = "Bearer " + getCookie("token");
    $(document).ready(function(){
        findMaterial();
        getToken();
        $("#add-material").click(function(){
            uploadMaterial();
        })
    });

    function uploadMaterial(){
        var data = {};
        data.actionUrl = $("#action-url").val() ? $("#action-url").val() : "";
        data.sortby = $("#sortby").val();
        data.category = $("#category option:selected").val();
        data.materialUrl = $("#material-url").val();
        console.log(data);
        $.ajax({
            url: "/was/material",
            method: "POST",
            headers : {
                "Authorization": authorization,
                "Content-Type" : "application/json"
            },
            data: JSON.stringify(data),
            success: function(){
                alert("add successfully...");
                window.location.reload();
            },
            error: function(){
                alert("error...try later...");
            }
        })
    }

    function findMaterial(){
        $.ajax({
            url: "/was/material",
            method: "get",
            data: {},
            headers: {
                "Authorization" : authorization
            },
            success: function(data){
                showMaterial(data);
            },
            error: function(jqXHR){
                if(jqXHR.status == 403){
                    $(".content").remove();
                    $(".main-panel").append("<h4 class='text-center' style='margin-top:20%'>&nbsp;&nbsp;Not Enough Permission to View This Page</h4>");
                }
                else if(jqXHR.status == 401){
                    window.location.href = "login.html"
                }
                else{
                    alert("error...try later...");
                }
            }
        })
    }

    function showMaterial(data){
        var html = "";
        for(var i in data){
            var d = data[i];
            var tmp = '' +
                '<tr> ' +
                '<td>'+d.id+'</td> ' +
                '<td><a href="'+d.materialUrl+'" target="_blank">"<img src="'+d.materialUrl+'" width="60px"/></a></td>' +
                '<td>'+d.category+'</td> ' +
                '<td>'+d.sortby+'</td> ' +
                '<td>'+d.actionUrl+'</td> ' +
                '<td><button class="btn btn-warning" data-id="'+d.id+'">删除</button></td>' +
                '</tr>';
            html += tmp;
        }
        var htmlDom = $(html);
        $("tbody").html(htmlDom);
        $("button", htmlDom).click(function(){
            deleteMaterial($(this).attr("data-id"));
        })
    }

    function deleteMaterial(id){
        $.ajax({
            url: "/was/material/"+id+"/rm",
            method: "POST",
            data: "{}",
            headers : {
                "Authorization": authorization,
                "Content-Type" : "application/json"
            },
            success: function(){
                alert("delete successful...");
                window.location.reload();
            },
            error: function(){
                alert("error...try later...");
            }
        })
    }

    function getToken(){
        $.ajax({
            url : "/util/qtoken",
            method : "GET",
            data: {},
            success: function(content){
                qiniuInit(content.data.material);
            },
            error: function(){
                alert("error, try again...");
            }
        })
    }

    function qiniuInit(token){
        uploader = Qiniu.uploader({
            runtimes: 'html5,flash,html4',      // 上传模式，依次退化
            browse_button: 'upload-select',         // 上传选择的点选按钮，必需
            // 在初始化时，uptoken，uptoken_url，uptoken_func三个参数中必须有一个被设置
            // 切如果提供了多个，其优先级为uptoken > uptoken_url > uptoken_func
            // 其中uptoken是直接提供上传凭证，uptoken_url是提供了获取上传凭证的地址，如果需要定制获取uptoken的过程则可以设置uptoken_func
            uptoken : token, // uptoken是上传凭证，由其他程序生成
            // uptoken_url: '/uptoken',         // Ajax请求uptoken的Url，强烈建议设置（服务端提供）
            // uptoken_func: function(file){    // 在需要获取uptoken时，该方法会被调用
            //    // do something
            //    return uptoken;
            // },
            get_new_uptoken: false,             // 设置上传文件的时候是否每次都重新获取新的uptoken
            // downtoken_url: '/downtoken',
            // Ajax请求downToken的Url，私有空间时使用，JS-SDK将向该地址POST文件的key和domain，服务端返回的JSON必须包含url字段，url值为该文件的下载地址
            // unique_names: true,              // 默认false，key为文件名。若开启该选项，JS-SDK会为每个文件自动生成key（文件名）
            save_key: true,                  // 默认false。若在服务端生成uptoken的上传策略中指定了sava_key，则开启，SDK在前端将不对key进行任何处理
            domain: 'http://pa9oqt0s0.bkt.clouddn.com',     // bucket域名，下载资源时用到，必需
            container: 'upload-area',             // 上传区域DOM ID，默认是browser_button的父元素
            max_file_size: '100mb',             // 最大文件体积限制
            flash_swf_url: 'flash/Moxie.swf',  //引入flash，相对路径
            max_retries: 0,                     // 上传失败最大重试次数
            dragdrop: false,                     // 开启可拖曳上传
            drop_element: 'container',          // 拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
            chunk_size: '4mb',                  // 分块上传时，每块的体积
            auto_start: true,                   // 选择文件后自动上传，若关闭需要自己绑定事件触发上传

            init: {
                'FilesAdded': function(up, files) {
                    $("a#preview").addClass("hidden");
                    plupload.each(files, function(file) {
                        // 文件添加进队列后，处理相关的事情
                    });
                },
                'BeforeUpload': function(up, file) {
                    console.log(file);
                },
                'UploadProgress': function(up, file) {
                    // 每个文件上传时，处理相关的事情
                },
                'FileUploaded': function(up, file, info) {
                    // 每个文件上传成功后，处理相关的事情
                    // 其中info是文件上传成功后，服务端返回的json，形式如：
                    // {
                    //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                    //    "key": "gogopher.jpg"
                    //  }
                    // 查看简单反馈
                    var domain = up.getOption('domain');
                    var res = JSON.parse(info);
                    var sourceLink = domain +"/"+ res.key; //获取上传成功后的文件的Url;
                    $("#material-url").val(sourceLink);
                    $("button#upload-select").text("上传成功");
                    console.log(sourceLink);
                },
                'Error': function(up, err, errTip) {
                    console.log(up);
                    console.log(err);
                    console.log(errTip);
                },
                'UploadComplete': function() {
                    //队列文件处理完毕后，处理相关的事情
                },
                'Key': function(up, file) {
                    // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                    // 该配置必须要在unique_names: false，save_key: false时才生效

                    var key = "";
                    // do something with key here
                    return key
                }
            }
        });

    }

    function getCookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }
</script>





</html>
